<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoNotes - Speech to Notes</title>
    
    <!-- React & Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .pulse-recording {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .wave-animation {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 30px;
        }
        
        .wave-bar {
            width: 4px;
            background: #667eea;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }
        
        .wave-bar:nth-child(1) { animation-delay: 0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes wave {
            0%, 100% { height: 10px; }
            50% { height: 30px; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // API Configuration
        const API_BASE_URL = 'http://localhost:8000';
        
        // ============== Icons ==============
        const Icons = {
            Mic: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" x2="12" y1="19" y2="22"></line>
                </svg>
            ),
            MicOff: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="2" x2="22" y1="2" y2="22"></line>
                    <path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-2"></path>
                    <path d="M5 10v2a7 7 0 0 0 12 5"></path>
                    <path d="M15 9.34V5a3 3 0 0 0-5.68-1.33"></path>
                    <path d="M9 9v3a3 3 0 0 0 5.12 2.12"></path>
                    <line x1="12" x2="12" y1="19" y2="22"></line>
                </svg>
            ),
            Upload: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" x2="12" y1="3" y2="15"></line>
                </svg>
            ),
            FileText: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" x2="8" y1="13" y2="13"></line>
                    <line x1="16" x2="8" y1="17" y2="17"></line>
                    <line x1="10" x2="8" y1="9" y2="9"></line>
                </svg>
            ),
            Download: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" x2="12" y1="15" y2="3"></line>
                </svg>
            ),
            Play: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
            ),
            Square: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
                </svg>
            ),
            Check: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            ),
            AlertCircle: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" x2="12" y1="8" y2="12"></line>
                    <line x1="12" x2="12.01" y1="16" y2="16"></line>
                </svg>
            ),
            Loader: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                </svg>
            ),
            Sparkles: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
                    <path d="M5 3v4"></path>
                    <path d="M19 17v4"></path>
                    <path d="M3 5h4"></path>
                    <path d="M17 19h4"></path>
                </svg>
            ),
            Settings: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            ),
            Music: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M9 18V5l12-2v13"></path>
                    <circle cx="6" cy="18" r="3"></circle>
                    <circle cx="18" cy="16" r="3"></circle>
                </svg>
            ),
        };
        
        // ============== Audio Recorder Hook (WAV format - no ffmpeg needed) ==============
        const useAudioRecorder = () => {
            const [isRecording, setIsRecording] = useState(false);
            const [audioBlob, setAudioBlob] = useState(null);
            const [audioUrl, setAudioUrl] = useState(null);
            const [duration, setDuration] = useState(0);
            const [error, setError] = useState(null);
            
            const audioContextRef = useRef(null);
            const processorRef = useRef(null);
            const streamRef = useRef(null);
            const chunksRef = useRef([]);
            const timerRef = useRef(null);
            
            // Convert Float32 samples to 16-bit PCM WAV
            const encodeWAV = (samples, sampleRate) => {
                const buffer = new ArrayBuffer(44 + samples.length * 2);
                const view = new DataView(buffer);
                
                // WAV header
                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };
                
                writeString(0, 'RIFF');
                view.setUint32(4, 36 + samples.length * 2, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true); // PCM format
                view.setUint16(20, 1, true);  // PCM
                view.setUint16(22, 1, true);  // Mono
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true); // byte rate
                view.setUint16(32, 2, true);  // block align
                view.setUint16(34, 16, true); // bits per sample
                writeString(36, 'data');
                view.setUint32(40, samples.length * 2, true);
                
                // Convert samples to 16-bit PCM
                let offset = 44;
                for (let i = 0; i < samples.length; i++) {
                    const s = Math.max(-1, Math.min(1, samples[i]));
                    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                    offset += 2;
                }
                
                return new Blob([buffer], { type: 'audio/wav' });
            };
            
            const startRecording = async () => {
                try {
                    setError(null);
                    chunksRef.current = [];
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        } 
                    });
                    streamRef.current = stream;
                    
                    // Create audio context at 16kHz (optimal for speech recognition)
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000
                    });
                    audioContextRef.current = audioContext;
                    
                    const source = audioContext.createMediaStreamSource(stream);
                    
                    // Use ScriptProcessor for recording (widely supported)
                    const processor = audioContext.createScriptProcessor(4096, 1, 1);
                    processorRef.current = processor;
                    
                    processor.onaudioprocess = (e) => {
                        const inputData = e.inputBuffer.getChannelData(0);
                        // Copy the samples
                        chunksRef.current.push(new Float32Array(inputData));
                    };
                    
                    source.connect(processor);
                    processor.connect(audioContext.destination);
                    
                    setIsRecording(true);
                    setDuration(0);
                    
                    timerRef.current = setInterval(() => {
                        setDuration(d => d + 1);
                    }, 1000);
                    
                } catch (err) {
                    setError('Microphone access denied. Please allow microphone access.');
                    console.error('Recording error:', err);
                }
            };
            
            const stopRecording = () => {
                if (!isRecording) return;
                
                // Stop timer
                clearInterval(timerRef.current);
                setIsRecording(false);
                
                // Disconnect processor
                if (processorRef.current) {
                    processorRef.current.disconnect();
                }
                
                // Stop stream
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                }
                
                // Close audio context
                if (audioContextRef.current) {
                    const sampleRate = audioContextRef.current.sampleRate;
                    audioContextRef.current.close();
                    
                    // Combine all chunks into one Float32Array
                    const totalLength = chunksRef.current.reduce((acc, chunk) => acc + chunk.length, 0);
                    const combined = new Float32Array(totalLength);
                    let offset = 0;
                    for (const chunk of chunksRef.current) {
                        combined.set(chunk, offset);
                        offset += chunk.length;
                    }
                    
                    // Convert to WAV blob
                    const wavBlob = encodeWAV(combined, sampleRate);
                    setAudioBlob(wavBlob);
                    setAudioUrl(URL.createObjectURL(wavBlob));
                }
            };
            
            const resetRecording = () => {
                setAudioBlob(null);
                setAudioUrl(null);
                setDuration(0);
                setError(null);
                chunksRef.current = [];
            };
            
            return {
                isRecording,
                audioBlob,
                audioUrl,
                duration,
                error,
                startRecording,
                stopRecording,
                resetRecording
            };
        };
        
        // ============== API Service ==============
        const apiService = {
            async checkHealth() {
                try {
                    const response = await fetch(`${API_BASE_URL}/health`);
                    return await response.json();
                } catch (err) {
                    throw new Error('API server not reachable');
                }
            },
            
            async processAudio(file, options) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('title', options.title || 'EchoNotes Document');
                formData.append('format', options.format || 'html');
                formData.append('use_ai', options.useAI ? 'true' : 'false');
                formData.append('language', options.language || 'en');
                
                const response = await fetch(`${API_BASE_URL}/api/process/sync`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Processing failed');
                }
                
                return await response.json();
            },
            
            async analyzeText(text, title, useAI) {
                const response = await fetch(`${API_BASE_URL}/api/analyze/enhanced`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, title, use_ai: useAI })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Analysis failed');
                }
                
                return await response.json();
            },
            
            async generateDocument(text, title, format, useAI) {
                const response = await fetch(`${API_BASE_URL}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text,
                        title,
                        format,
                        use_ai: useAI,
                        include_full_content: true
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Generation failed');
                }
                
                return await response.json();
            },
            
            getDownloadUrl(jobId) {
                return `${API_BASE_URL}/api/download/${jobId}`;
            }
        };
        
        // ============== Components ==============
        
        // Header Component
        const Header = () => (
            <header className="gradient-bg text-white py-6 px-4 shadow-lg">
                <div className="max-w-6xl mx-auto flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <Icons.Music />
                        </div>
                        <div>
                            <h1 className="text-2xl font-bold">EchoNotes</h1>
                            <p className="text-white/80 text-sm">Speech to Notes AI</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-2 text-sm bg-white/20 px-4 py-2 rounded-full">
                        <div className="w-2 h-2 bg-green-400 rounded-full"></div>
                        <span>API Connected</span>
                    </div>
                </div>
            </header>
        );
        
        // Audio Wave Animation
        const AudioWave = () => (
            <div className="wave-animation">
                {[...Array(5)].map((_, i) => (
                    <div key={i} className="wave-bar"></div>
                ))}
            </div>
        );
        
        // Format Duration
        const formatDuration = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };
        
        // Recording Panel
        const RecordingPanel = ({ onAudioReady }) => {
            const recorder = useAudioRecorder();
            
            const handleUseRecording = () => {
                if (recorder.audioBlob) {
                    const file = new File([recorder.audioBlob], 'recording.wav', { type: 'audio/wav' });
                    onAudioReady(file);
                }
            };
            
            return (
                <div className="bg-white rounded-2xl shadow-lg p-8 fade-in">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center text-red-600">
                            <Icons.Mic />
                        </div>
                        <div>
                            <h2 className="text-xl font-semibold">Record Audio</h2>
                            <p className="text-gray-500 text-sm">Record your lecture or meeting</p>
                        </div>
                    </div>
                    
                    {recorder.error && (
                        <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 flex items-center gap-2">
                            <Icons.AlertCircle />
                            <span>{recorder.error}</span>
                        </div>
                    )}
                    
                    <div className="flex flex-col items-center py-8">
                        {/* Recording Button */}
                        <button
                            onClick={recorder.isRecording ? recorder.stopRecording : recorder.startRecording}
                            className={`w-24 h-24 rounded-full flex items-center justify-center transition-all ${
                                recorder.isRecording 
                                    ? 'bg-red-500 hover:bg-red-600 pulse-recording' 
                                    : 'bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700'
                            } text-white shadow-lg`}
                        >
                            {recorder.isRecording ? <Icons.Square /> : <Icons.Mic />}
                        </button>
                        
                        {/* Status */}
                        <div className="mt-6 text-center">
                            {recorder.isRecording ? (
                                <>
                                    <AudioWave />
                                    <p className="text-red-500 font-medium mt-2">Recording...</p>
                                    <p className="text-2xl font-mono mt-1">{formatDuration(recorder.duration)}</p>
                                </>
                            ) : recorder.audioUrl ? (
                                <>
                                    <p className="text-green-600 font-medium flex items-center gap-2">
                                        <Icons.Check /> Recording Complete
                                    </p>
                                    <p className="text-gray-500 mt-1">Duration: {formatDuration(recorder.duration)}</p>
                                </>
                            ) : (
                                <p className="text-gray-500">Click to start recording</p>
                            )}
                        </div>
                        
                        {/* Audio Preview & Actions */}
                        {recorder.audioUrl && (
                            <div className="mt-6 w-full max-w-md">
                                <audio src={recorder.audioUrl} controls className="w-full mb-4" />
                                <div className="flex gap-3">
                                    <button
                                        onClick={recorder.resetRecording}
                                        className="flex-1 py-3 px-4 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors"
                                    >
                                        Record Again
                                    </button>
                                    <button
                                        onClick={handleUseRecording}
                                        className="flex-1 py-3 px-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl hover:from-indigo-600 hover:to-purple-700 transition-colors flex items-center justify-center gap-2"
                                    >
                                        <Icons.Sparkles /> Process
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        // File Upload Panel
        const FileUploadPanel = ({ onFileReady, onTextReady }) => {
            const [dragActive, setDragActive] = useState(false);
            const [selectedFile, setSelectedFile] = useState(null);
            const [textContent, setTextContent] = useState('');
            const [uploadMode, setUploadMode] = useState('audio'); // 'audio' or 'text'
            const fileInputRef = useRef(null);
            
            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === 'dragenter' || e.type === 'dragover') {
                    setDragActive(true);
                } else if (e.type === 'dragleave') {
                    setDragActive(false);
                }
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFile(e.dataTransfer.files[0]);
                }
            };
            
            const handleFile = (file) => {
                setSelectedFile(file);
                
                // If it's a text file, read its content
                if (file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setTextContent(e.target.result);
                    };
                    reader.readAsText(file);
                }
            };
            
            const handleProcess = () => {
                if (uploadMode === 'text' && textContent) {
                    onTextReady(textContent);
                } else if (selectedFile) {
                    if (selectedFile.name.endsWith('.txt')) {
                        onTextReady(textContent);
                    } else {
                        onFileReady(selectedFile);
                    }
                }
            };
            
            return (
                <div className="bg-white rounded-2xl shadow-lg p-8 fade-in">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600">
                            <Icons.Upload />
                        </div>
                        <div>
                            <h2 className="text-xl font-semibold">Upload File</h2>
                            <p className="text-gray-500 text-sm">Upload audio or text file</p>
                        </div>
                    </div>
                    
                    {/* Mode Toggle */}
                    <div className="flex gap-2 mb-6">
                        <button
                            onClick={() => setUploadMode('audio')}
                            className={`flex-1 py-2 px-4 rounded-xl transition-colors ${
                                uploadMode === 'audio' 
                                    ? 'bg-indigo-100 text-indigo-700 border-2 border-indigo-300' 
                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                            }`}
                        >
                            Audio File
                        </button>
                        <button
                            onClick={() => setUploadMode('text')}
                            className={`flex-1 py-2 px-4 rounded-xl transition-colors ${
                                uploadMode === 'text' 
                                    ? 'bg-indigo-100 text-indigo-700 border-2 border-indigo-300' 
                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                            }`}
                        >
                            Text / Transcript
                        </button>
                    </div>
                    
                    {uploadMode === 'audio' ? (
                        /* Audio Upload Area */
                        <div
                            className={`border-2 border-dashed rounded-xl p-8 text-center transition-colors ${
                                dragActive 
                                    ? 'border-indigo-500 bg-indigo-50' 
                                    : 'border-gray-300 hover:border-gray-400'
                            }`}
                            onDragEnter={handleDrag}
                            onDragLeave={handleDrag}
                            onDragOver={handleDrag}
                            onDrop={handleDrop}
                            onClick={() => fileInputRef.current?.click()}
                        >
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept="audio/*,.wav,.mp3,.ogg,.webm,.m4a"
                                onChange={(e) => e.target.files[0] && handleFile(e.target.files[0])}
                                className="hidden"
                            />
                            
                            {selectedFile && !selectedFile.name.endsWith('.txt') ? (
                                <div className="flex flex-col items-center">
                                    <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-4">
                                        <Icons.Check />
                                    </div>
                                    <p className="font-medium">{selectedFile.name}</p>
                                    <p className="text-gray-500 text-sm">
                                        {(selectedFile.size / 1024 / 1024).toFixed(2)} MB
                                    </p>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center">
                                    <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 mb-4">
                                        <Icons.Upload />
                                    </div>
                                    <p className="font-medium text-gray-700">Drop audio file here</p>
                                    <p className="text-gray-500 text-sm mt-1">or click to browse</p>
                                    <p className="text-gray-400 text-xs mt-3">WAV, MP3, OGG, WebM, M4A</p>
                                </div>
                            )}
                        </div>
                    ) : (
                        /* Text Input Area */
                        <div>
                            <textarea
                                value={textContent}
                                onChange={(e) => setTextContent(e.target.value)}
                                placeholder="Paste your transcript or text here..."
                                className="w-full h-48 p-4 border border-gray-300 rounded-xl resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                            />
                            <div className="flex justify-between items-center mt-2 text-sm text-gray-500">
                                <span>{textContent.split(/\s+/).filter(w => w).length} words</span>
                                <label className="cursor-pointer text-indigo-600 hover:text-indigo-700">
                                    <input
                                        type="file"
                                        accept=".txt"
                                        onChange={(e) => e.target.files[0] && handleFile(e.target.files[0])}
                                        className="hidden"
                                    />
                                    Upload .txt file
                                </label>
                            </div>
                        </div>
                    )}
                    
                    {/* Process Button */}
                    {(selectedFile || textContent) && (
                        <button
                            onClick={handleProcess}
                            className="w-full mt-6 py-3 px-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl hover:from-indigo-600 hover:to-purple-700 transition-colors flex items-center justify-center gap-2"
                        >
                            <Icons.Sparkles /> Process with AI
                        </button>
                    )}
                </div>
            );
        };
        
        // Settings Panel
        const SettingsPanel = ({ settings, onSettingsChange }) => (
            <div className="bg-white rounded-2xl shadow-lg p-6 fade-in">
                <div className="flex items-center gap-3 mb-6">
                    <div className="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600">
                        <Icons.Settings />
                    </div>
                    <h2 className="text-xl font-semibold">Settings</h2>
                </div>
                
                <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Document Title</label>
                        <input
                            type="text"
                            value={settings.title}
                            onChange={(e) => onSettingsChange({ ...settings, title: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="My Notes"
                        />
                    </div>
                    
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Output Format</label>
                        <select
                            value={settings.format}
                            onChange={(e) => onSettingsChange({ ...settings, format: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                        >
                            <option value="html">HTML (Recommended)</option>
                            <option value="md">Markdown</option>
                            <option value="pdf">PDF</option>
                            <option value="docx">Word Document</option>
                            <option value="txt">Plain Text</option>
                        </select>
                    </div>
                    
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="font-medium text-gray-700">AI Enhancement</p>
                            <p className="text-sm text-gray-500">Generate explanations, examples, FAQ</p>
                        </div>
                        <label className="relative inline-flex items-center cursor-pointer">
                            <input
                                type="checkbox"
                                checked={settings.useAI}
                                onChange={(e) => onSettingsChange({ ...settings, useAI: e.target.checked })}
                                className="sr-only peer"
                            />
                            <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        </label>
                    </div>
                </div>
            </div>
        );
        
        // Processing Status
        const ProcessingStatus = ({ status, message }) => (
            <div className="bg-white rounded-2xl shadow-lg p-8 fade-in">
                <div className="flex flex-col items-center py-8">
                    <div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mb-6">
                        <Icons.Loader />
                    </div>
                    <h3 className="text-xl font-semibold mb-2">Processing</h3>
                    <p className="text-gray-500 loading-dots">{message}</p>
                    
                    <div className="mt-8 w-full max-w-md">
                        <div className="flex justify-between text-sm text-gray-500 mb-2">
                            <span>Progress</span>
                            <span>{status}%</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                            <div 
                                className="bg-gradient-to-r from-indigo-500 to-purple-600 h-2 rounded-full transition-all duration-500"
                                style={{ width: `${status}%` }}
                            ></div>
                        </div>
                    </div>
                </div>
            </div>
        );
        
        // Results Panel
        const ResultsPanel = ({ result, onDownload, onReset }) => (
            <div className="bg-white rounded-2xl shadow-lg p-8 fade-in">
                <div className="flex items-center gap-3 mb-6">
                    <div className="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center text-green-600">
                        <Icons.Check />
                    </div>
                    <div>
                        <h2 className="text-xl font-semibold">Processing Complete!</h2>
                        <p className="text-gray-500 text-sm">Your document is ready</p>
                    </div>
                </div>
                
                {/* Results Summary */}
                {result.transcript && (
                    <div className="mb-6 p-4 bg-gray-50 rounded-xl">
                        <h3 className="font-medium mb-2">Transcript Preview</h3>
                        <p className="text-gray-600 text-sm line-clamp-3">
                            {result.transcript.text?.substring(0, 300)}...
                        </p>
                        <div className="flex gap-4 mt-3 text-sm text-gray-500">
                            <span>Words: {result.transcript.word_count}</span>
                            <span>Confidence: {Math.round(result.transcript.confidence * 100)}%</span>
                        </div>
                    </div>
                )}
                
                {/* Analysis Summary */}
                {result.analysis && (
                    <div className="mb-6 p-4 bg-indigo-50 rounded-xl">
                        <h3 className="font-medium mb-2">Key Concepts</h3>
                        <div className="flex flex-wrap gap-2">
                            {result.analysis.key_concepts?.slice(0, 5).map((concept, i) => (
                                <span key={i} className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm">
                                    {concept}
                                </span>
                            ))}
                        </div>
                    </div>
                )}
                
                {/* Download Button */}
                <div className="flex gap-3">
                    <button
                        onClick={onReset}
                        className="flex-1 py-3 px-4 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors"
                    >
                        Process Another
                    </button>
                    <button
                        onClick={onDownload}
                        className="flex-1 py-3 px-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl hover:from-green-600 hover:to-emerald-700 transition-colors flex items-center justify-center gap-2"
                    >
                        <Icons.Download /> Download Document
                    </button>
                </div>
            </div>
        );
        
        // Error Display
        const ErrorDisplay = ({ error, onRetry }) => (
            <div className="bg-white rounded-2xl shadow-lg p-8 fade-in">
                <div className="flex flex-col items-center py-8">
                    <div className="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center text-red-600 mb-6">
                        <Icons.AlertCircle />
                    </div>
                    <h3 className="text-xl font-semibold mb-2">Processing Failed</h3>
                    <p className="text-gray-500 text-center mb-6">{error}</p>
                    <button
                        onClick={onRetry}
                        className="py-3 px-8 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl hover:from-indigo-600 hover:to-purple-700 transition-colors"
                    >
                        Try Again
                    </button>
                </div>
            </div>
        );
        
        // ============== Main App ==============
        const App = () => {
            const [step, setStep] = useState('input'); // input, processing, results, error
            const [settings, setSettings] = useState({
                title: 'EchoNotes Document',
                format: 'html',
                useAI: true,
                language: 'en'
            });
            const [processingStatus, setProcessingStatus] = useState(0);
            const [processingMessage, setProcessingMessage] = useState('');
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            
            const processAudio = async (file) => {
                setStep('processing');
                setProcessingStatus(10);
                setProcessingMessage('Uploading audio');
                
                try {
                    setProcessingStatus(30);
                    setProcessingMessage('Transcribing audio');
                    
                    const result = await apiService.processAudio(file, settings);
                    
                    setProcessingStatus(100);
                    setProcessingMessage('Complete');
                    setResult(result);
                    setStep('results');
                    
                } catch (err) {
                    setError(err.message);
                    setStep('error');
                }
            };
            
            const processText = async (text) => {
                setStep('processing');
                setProcessingStatus(20);
                setProcessingMessage('Analyzing text');
                
                try {
                    setProcessingStatus(50);
                    setProcessingMessage('Generating document');
                    
                    const genResult = await apiService.generateDocument(
                        text,
                        settings.title,
                        settings.format,
                        settings.useAI
                    );
                    
                    setProcessingStatus(100);
                    setProcessingMessage('Complete');
                    setResult({ document: genResult });
                    setStep('results');
                    
                } catch (err) {
                    setError(err.message);
                    setStep('error');
                }
            };
            
            const handleDownload = () => {
                if (result?.document?.document_path) {
                    window.open(`${API_BASE_URL}${result.document.document_path}`, '_blank');
                } else if (result?.document?.job_id) {
                    window.open(apiService.getDownloadUrl(result.document.job_id), '_blank');
                }
            };
            
            const handleReset = () => {
                setStep('input');
                setResult(null);
                setError(null);
                setProcessingStatus(0);
            };
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200">
                    <Header />
                    
                    <main className="max-w-6xl mx-auto px-4 py-8">
                        {step === 'input' && (
                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="space-y-6">
                                    <RecordingPanel onAudioReady={processAudio} />
                                    <FileUploadPanel 
                                        onFileReady={processAudio}
                                        onTextReady={processText}
                                    />
                                </div>
                                <div>
                                    <SettingsPanel 
                                        settings={settings}
                                        onSettingsChange={setSettings}
                                    />
                                </div>
                            </div>
                        )}
                        
                        {step === 'processing' && (
                            <div className="max-w-xl mx-auto">
                                <ProcessingStatus 
                                    status={processingStatus}
                                    message={processingMessage}
                                />
                            </div>
                        )}
                        
                        {step === 'results' && (
                            <div className="max-w-xl mx-auto">
                                <ResultsPanel 
                                    result={result}
                                    onDownload={handleDownload}
                                    onReset={handleReset}
                                />
                            </div>
                        )}
                        
                        {step === 'error' && (
                            <div className="max-w-xl mx-auto">
                                <ErrorDisplay 
                                    error={error}
                                    onRetry={handleReset}
                                />
                            </div>
                        )}
                    </main>
                    
                    <footer className="text-center py-6 text-gray-500 text-sm">
                        <p>EchoNotes - Speech to Notes AI • Made with ❤️</p>
                    </footer>
                </div>
            );
        };
        
        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
